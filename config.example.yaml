# StreamRelay Configuration
# A generic JWT-authenticated Redis-to-SSE/WebSocket relay.

server:
  host: "0.0.0.0"
  port: 8080
  # Seconds between keepalive pings sent to connected clients.
  # Also the interval at which token expiry is checked.
  heartbeat_seconds: 30
  # Maximum concurrent client connections (0 = unlimited).
  max_connections_total: 10000
  # Maximum concurrent connections per unique identity (0 = unlimited).
  # Prevents a single user from exhausting server resources.
  max_connections_per_identity: 5
  # Maximum inbound WebSocket message size in bytes.
  max_message_size_bytes: 4096
  # Per-client send buffer size (number of messages). When the buffer is
  # full, the slow_consumer_policy determines what happens.
  # Increase for bursty, high-throughput streams.
  # client_buffer_size: 64
  # What to do when a client's send buffer is full:
  #   drop_newest_message - discard the message for that client, keep connected (default)
  #   drop_client         - disconnect the slow client
  # slow_consumer_policy: "drop_newest_message"
  # Seconds between WebSocket ping frames. Connections that miss two
  # consecutive pongs are considered dead and closed.
  # websocket_ping_seconds: 30
  # Maximum time in milliseconds to wait for a WebSocket write (message
  # or ping) to complete before closing the connection.
  # websocket_write_timeout_ms: 10000
  # Graceful shutdown timeout in seconds.
  shutdown_timeout_seconds: 10
  # Allowed origins for CORS and WebSocket upgrade.
  # If empty, all cross-origin requests are rejected.
  # Use ["*"] to allow all origins (NOT recommended for production).
  allowed_origins:
    - "http://localhost:3000"
    - "http://localhost:5173"
    - "http://127.0.0.1:3000"
    - "http://127.0.0.1:5173"
  # Restrict the /stats endpoint to a specific identity. When set, only
  # tokens with this identity value can access /stats. When empty, any
  # authenticated user can access it.
  # stats_identity: "admin"

auth:
  # JWT signing secret for HS256/HS384/HS512 (symmetric).
  # Must be at least 32 characters.
  # Set EITHER jwt_secret OR jwt_public_key, not both.
  # IMPORTANT: Use STREAMRELAY_AUTH_JWT_SECRET env var in production.
  jwt_secret: ""

  # Path to PEM-encoded public key for RS256/RS384/RS512/ES256/ES384/ES512.
  # jwt_public_key: "/path/to/public.pem"

  # Which JWT claim contains the user/client identity.
  # This value is used as the Redis channel suffix.
  # Must contain only alphanumeric characters, dots, hyphens, underscores.
  identity_claim: "sub"

  # Optional: reject tokens not issued by this issuer (JWT "iss" claim).
  # Prevents cross-service token reuse when sharing signing keys.
  # expected_issuer: "https://api.example.com"

  # Optional: reject tokens not intended for this audience (JWT "aud" claim).
  # expected_audience: "streamrelay"

  # Reject tokens that have no "exp" (expiration) claim. Defaults to true.
  # Set to false only if your token issuer intentionally omits expiry.
  require_expiry: true

  # Optional: service authentication token for remote verify/refresh endpoints.
  # When set, StreamRelay adds an "Authorization: Bearer <token>" header to
  # all outbound requests to the verify and refresh endpoints.
  # Use this when your API requires service-to-service authentication.
  # IMPORTANT: Use STREAMRELAY_AUTH_SERVICE_TOKEN env var in production.
  # service_token: ""

  # Optional: remote token verification endpoint.
  # When configured, the relay will call this endpoint to verify tokens
  # in addition to local JWT signature/expiry validation.
  # Follows OAuth2 Token Introspection (RFC 7662) conventions by default.
  # NOTE: SSRF protection blocks requests to private/link-local addresses.
  # verify:
  #   url: "https://api.example.com/auth/introspect"
  #   method: "POST"                    # HTTP method
  #   token_param: "token"              # parameter name for the JWT
  #   token_location: "body"            # body | header | query
  #   active_field: "active"            # response field that must be true
  #   identity_field: "sub"             # response field containing identity
  #   cache_seconds: 60                 # cache successful verifications

  # Optional: automatic token refresh.
  # When configured, the relay will proactively refresh tokens before expiry.
  # The client must provide a refresh_token via the X-Refresh-Token header.
  # If not configured, clients are notified of expiry and must reconnect.
  # refresh:
  #   url: "https://api.example.com/auth/refresh"
  #   method: "POST"
  #   token_param: "refresh_token"      # parameter name for the refresh token
  #   token_location: "body"            # body | header | query
  #   new_token_field: "access_token"   # response field containing new JWT
  #   interval_seconds: 1800            # refresh this many seconds before expiry

redis:
  url: "redis://localhost:6379"
  # Optional password (can also be in the URL as redis://:password@host:port).
  # password: ""
  # Redis database number (0-15).
  db: 0
  # Prefix for user channels. The relay subscribes to {prefix}:{identity}.
  channel_prefix: "streams"

transports:
  # Enable Server-Sent Events endpoint at GET /events
  sse: true
  # Enable WebSocket endpoint at GET /ws
  websocket: true
  # When websocket is enabled and a client sends a message, publish it
  # to Redis at {inbound_prefix}:{identity}. Set to "" to disable inbound.
  # NOTE: Consumers of inbound channels must treat all data as untrusted
  # user input. StreamRelay relays messages without validation.
  inbound_prefix: "inbound"

logging:
  # Log level: debug, info, warn, error
  level: "info"
  # Log format: text or json
  format: "text"
